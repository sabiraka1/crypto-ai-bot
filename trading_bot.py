import ccxt
import os
from dotenv import load_dotenv
from telegram_bot import send_telegram_message
from sinyal_skorlayici import evaluate_signal
from data_logger import log_trade
from technical_analysis import generate_signal

load_dotenv()

api_key = os.getenv("GATE_API_KEY")
api_secret = os.getenv("GATE_API_SECRET")
chat_id = os.getenv("CHAT_ID")

exchange = ccxt.gateio({
    'apiKey': api_key,
    'secret': api_secret,
    'enableRateLimit': True,
})

symbol = 'BTC/USDT'
amount_usdt = 10  # —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è —Å–¥–µ–ª–∫–∏

def get_price():
    ticker = exchange.fetch_ticker(symbol)
    return ticker['last']

def execute_order(side, usdt_amount):
    price = get_price()
    amount = round(usdt_amount / price, 6)
    try:
        order = exchange.create_market_order(symbol, side, amount)
        return order
    except Exception as e:
        send_telegram_message(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ä–¥–µ—Ä–µ: {e}")
        return None

def check_and_trade():
    signal = generate_signal()
    score = evaluate_signal(signal)
    price = get_price()

    message = f"üìä –°–∏–≥–Ω–∞–ª: {signal}\nü§ñ –û—Ü–µ–Ω–∫–∞ AI: {score:.2f}\nüí∞ –¶–µ–Ω–∞: {price}"
    send_telegram_message(message)

    if score >= 0.8:
        side = 'buy' if signal == 'BUY' else 'sell'
        order = execute_order(side, amount_usdt)
        if order:
            log_trade(signal, score, price, success=True)
            send_telegram_message(f"‚úÖ –û—Ç–∫—Ä—ã—Ç–∞ —Å–¥–µ–ª–∫–∞ {side.upper()} –Ω–∞ {amount_usdt}$")
        else:
            log_trade(signal, score, price, success=False)
    else:
        log_trade(signal, score, price, success=False)
