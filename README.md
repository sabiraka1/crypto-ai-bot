# CRYPTO-AI-BOT ‚Äî —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞

Production-grade —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç (—è–¥—Ä–æ) –¥–ª—è –±—É–¥—É—â–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞: —Å—Ç—Ä–æ–≥–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã, —Å–æ–±—ã—Ç–∏–π–Ω–∞—è —à–∏–Ω–∞ —Å –ø–æ—Ä—è–¥–∫–æ–º –ø–æ –∫–ª—é—á—É, –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å, –º–µ—Ç—Ä–∏–∫–∏/health, —á–∏—Å—Ç—ã–π DI –∏ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ª–æ–∏. –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —É–∂–µ –ø–æ–∫—Ä—ã—Ç —Ç–µ—Å—Ç–∞–º–∏ (**32 passed**).

---

## üöÄ –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **–ß—ë—Ç–∫–∞—è —Å–µ–º–∞–Ω—Ç–∏–∫–∞ –æ—Ä–¥–µ—Ä–æ–≤ (–±–µ–∑ –¥–≤—É—Å–º—ã—Å–ª–µ–Ω–Ω–æ—Å—Ç–∏):**
  - `create_market_buy_quote(symbol, quote_amount)` ‚Üí —Å—É–º–º–∞ **–≤ –∫–æ—Ç–∏—Ä—É–µ–º–æ–π –≤–∞–ª—é—Ç–µ** (–Ω–∞–ø—Ä–∏–º–µ—Ä, USDT).
  - `create_market_sell_base(symbol, base_amount)` ‚Üí –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ **–≤ –±–∞–∑–æ–≤–æ–π –≤–∞–ª—é—Ç–µ** (–Ω–∞–ø—Ä–∏–º–µ—Ä, BTC).
- **–°–æ–±—ã—Ç–∏–π–Ω–∞—è —à–∏–Ω–∞ (EventBus):**
  - Per-key ordering (—Å—Ç—Ä–æ–≥–∏–π –ø–æ—Ä—è–¥–æ–∫ –≤–Ω—É—Ç—Ä–∏ `(topic, key)`), –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –º–µ–∂–¥—É –∫–ª—é—á–∞–º–∏.
  - –õ–µ–Ω–∏–≤—ã–π —Å—Ç–∞—Ä—Ç –≤–æ—Ä–∫–µ—Ä–æ–≤ (–Ω–∞–¥—ë–∂–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º DI/—Ç–µ—Å—Ç–∞—Ö).
  - DLQ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ –∏ –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º–∏.
  - –†–µ—Ç—Ä–∞–∏ –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º –±—ç–∫-–æ—Ñ—Ñ–æ–º.
- **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π:** —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –∫–ª—é—á–∏ —Å –±–∞–∫–µ—Ç–∏–∑–∞—Ü–∏–µ–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏, TTL.
- **–†–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç –∏ –∑–∞—â–∏—Ç–Ω—ã–µ –≤—ã—Ö–æ–¥—ã:** cooldown, —Å–ø—Ä–µ–¥-—Ñ–∏–ª—å—Ç—Ä, `ProtectiveExits` (TP/SL-–ø–ª–∞–Ω).
- **–°–∏–≥–Ω–∞–ª—ã:** –±–∞–∑–æ–≤—ã–µ —Ñ–∏—á–∏ (SMA/EMA/—Å–ø—Ä–µ–¥), –ø–æ–ª–∏—Ç–∏–∫–∞ `buy/sell/hold`.
- **–•—Ä–∞–Ω–∏–ª–∏—â–µ:** SQLite + –º–∏–≥—Ä–∞—Ü–∏–∏, —Ñ–∞—Å–∞–¥ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ (trades, positions, market_data, audit, idempotency).
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** `/health` –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç DB/–º–∏–≥—Ä–∞—Ü–∏–∏/–±—Ä–æ–∫–µ—Ä/EventBus, `/metrics` ‚Äî Prometheus –∏–ª–∏ JSON fallback.
- **DI –∏ —Å–µ—Ä–≤–µ—Ä:** FastAPI (`/live`, `/ready`, `/health`, `/status`, `/metrics`, `/telegram/webhook`).
- **–¢–µ—Å—Ç—ã:** unit + integration, –±—ã—Å—Ç—Ä—ã–π —Å–º–æ–∫-—Å–∫—Ä–∏–ø—Ç.

---

## üß± –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
src/crypto_ai_bot/
‚îú‚îÄ app/
‚îÇ  ‚îú‚îÄ compose.py                  # DI-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, lifecycle (startup/shutdown)
‚îÇ  ‚îú‚îÄ server.py                   # FastAPI —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
‚îÇ  ‚îî‚îÄ adapters/telegram.py        # –ø–∞—Ä—Å–µ—Ä /eval, /buy <USDT>, /sell [BASE]
‚îú‚îÄ core/
‚îÇ  ‚îú‚îÄ events/
‚îÇ  ‚îÇ  ‚îî‚îÄ bus.py                   # AsyncEventBus: per-key order, DLQ, lazy start
‚îÇ  ‚îú‚îÄ brokers/
‚îÇ  ‚îÇ  ‚îú‚îÄ backtest_exchange.py
‚îÇ  ‚îÇ  ‚îî‚îÄ ccxt_exchange.py         # live-—Ä–µ–∂–∏–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, Gate.io)
‚îÇ  ‚îú‚îÄ storage/
‚îÇ  ‚îÇ  ‚îú‚îÄ sqlite_adapter.py
‚îÇ  ‚îÇ  ‚îú‚îÄ migrations/
‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ runner.py
‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ 0001_init.sql         # —á–∏—Å—Ç—ã–π SQL (–±–µ–∑ markdown-—Ñ–µ–Ω—Å–æ–≤)
‚îÇ  ‚îÇ  ‚îî‚îÄ repositories/            # idempotency, trades, positions, market_data, audit
‚îÇ  ‚îú‚îÄ use_cases/                  # evaluate, place_order, execute_trade, reconcile, eval_and_execute
‚îÇ  ‚îú‚îÄ risk/                       # RiskManager, ProtectiveExits
‚îÇ  ‚îú‚îÄ signals/                    # _build (SMA/EMA/—Å–ø—Ä–µ–¥), policy
‚îÇ  ‚îú‚îÄ monitoring/                 # HealthChecker
‚îÇ  ‚îî‚îÄ analytics/                  # PnL/–º–µ—Ç—Ä–∏–∫–∏ –æ—Ç—á—ë—Ç–∞
‚îî‚îÄ utils/                         # time, ids, logging, metrics, retry, circuit_breaker, exceptions
```

```
–¢–µ—Å—Ç—ã:
tests/
‚îú‚îÄ unit/
‚îú‚îÄ integration/
‚îî‚îÄ conftest.py
```

---

## üß© –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- Python **3.12+** (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å 3.13)
- FastAPI, httpx, pydantic (–≤ —Å–æ—Å—Ç–∞–≤–µ FastAPI), sqlite3
- (–æ–ø—Ü.) prometheus_client ‚Äî —Ç–µ–∫—Å—Ç–æ–≤—ã–π `/metrics`
- ccxt ‚Äî –¥–ª—è live-–±–∏—Ä–∂ (–≤ dev –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω)
- pytest, anyio/pytest-asyncio ‚Äî —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## ‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# 1) –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
git clone <your-repo-url>
cd crypto-ai-bot

# 2) –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
python -m venv .venv
# Windows:
.venv\Scripts\activate
# Linux/macOS:
source .venv/bin/activate

# 3) –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip install -r requirements.txt
pip install -r requirements-dev.txt
```

Windows —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –≤ –ø—É—Ç–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞–≤—ã—á–∫–∏:

```bat
cd "C:\Users\<USERNAME>\Documents\GitHub\crypto-ai-bot"
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (ENV)

–û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (—Å–º. `core/settings.py`):

| ENV | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|-----|------------|--------|
| MODE | paper \| live | paper |
| EXCHANGE | –∏–º—è –±–∏—Ä–∂–∏ –¥–ª—è live (ccxt) | gateio |
| SYMBOL | —Ç–æ—Ä–≥–æ–≤–∞—è –ø–∞—Ä–∞ | BTC/USDT |
| DB_PATH | –ø—É—Ç—å –∫ SQLite –ë–î | ./crypto_ai_bot.db |
| FIXED_AMOUNT | –¥–µ—Ñ–æ–ª—Ç–Ω–∞—è —Å—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏ (quote) | 10 |
| IDEMPOTENCY_BUCKET_MS | —à–∏—Ä–∏–Ω–∞ –±–∞–∫–µ—Ç–∞ –¥–ª—è –∫–ª—é—á–µ–π | 60000 |
| IDEMPOTENCY_TTL_SEC | TTL –∫–ª—é—á–µ–π –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ | 60 |
| API_KEY / API_SECRET | –∫–ª—é—á–∏ –¥–ª—è live-—Ä–µ–∂–∏–º–∞ | ... |
| TELEGRAM_ENABLED | 1 –≤–∫–ª—é—á–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–µ–±—Ö—É–∫–∞ | 0 |

`Settings.load()` ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ç–æ—á–∫–∞ —á—Ç–µ–Ω–∏—è ENV; –≤–∞–ª–∏–¥–∞—Ü–∏—è ‚Äî –≤ `core/validators/settings.py`.

## ‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞

```bash
uvicorn crypto_ai_bot.app.server:app --reload
# –û—Ç–∫—Ä–æ–π:
# GET /live   ‚Üí {"ok": true}
# GET /ready  ‚Üí 200/503 (DB & –º–∏–≥—Ä–∞—Ü–∏–∏)
# GET /health ‚Üí –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á—ë—Ç (DB/–º–∏–≥—Ä–∞—Ü–∏–∏/–±—Ä–æ–∫–µ—Ä/EventBus)
# GET /metrics ‚Üí Prometheus-—Ç–µ–∫—Å—Ç –∏–ª–∏ JSON fallback (PnL-–æ—Ç—á—ë—Ç)
# GET /status  ‚Üí –∫—Ä–∞—Ç–∫–∏–π —Å—Ç–∞—Ç—É—Å/—Å—á—ë—Ç—á–∏–∫–∏
```

Telegram webhook:

- –í–∫–ª—é—á–∏—Ç—å: `TELEGRAM_ENABLED=1`
- `POST /telegram/webhook` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π update –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã:
  - `/eval`
  - `/buy <USDT>` (—Å—É–º–º–∞ –≤ –∫–æ—Ç–∏—Ä—É–µ–º–æ–π –≤–∞–ª—é—Ç–µ)
  - `/sell [BASE]` (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –±–∞–∑–æ–≤–æ–π –≤–∞–ª—é—Ç–µ; –±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ ‚Äî –≤—Å—è –ø–æ–∑–∏—Ü–∏—è)

## üß™ –¢–µ—Å—Ç—ã –∏ —Å–º–æ–∫-–ø—Ä–æ–≥–æ–Ω

```bash
pytest -q
# –∏–ª–∏ –ø–æ –≥—Ä—É–ø–ø–∞–º:
pytest -q tests/unit
pytest -q tests/integration
```

–°–º–æ–∫-—Å–∫—Ä–∏–ø—Ç:

```bash
python -m crypto_ai_bot.app.dev_smoke
# –í—ã–ø–æ–ª–Ω–∏—Ç BUY ‚Üí SELL ‚Üí –≤—ã–≤–µ–¥–µ—Ç PnL –∏ HEALTH
```

`pytest.ini` —Å–æ–¥–µ—Ä–∂–∏—Ç `pythonpath = src`, –ø–æ—ç—Ç–æ–º—É –∏–º–ø–æ—Ä—Ç—ã –ø–∞–∫–µ—Ç–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –∏–∑ –∫–æ—Ä–Ω—è —Ä–µ–ø–æ.

## üß† EventBus ‚Äî –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

- **Per-key ordering** ‚Äî –ø–æ—Ä—è–¥–æ–∫ —Å—Ç—Ä–æ–≥–∏–π –≤–Ω—É—Ç—Ä–∏ `(topic, key)`.
- **–ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º** ‚Äî —Ä–∞–∑–Ω—ã–µ –∫–ª—é—á–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–º–∏ –≤–æ—Ä–∫–µ—Ä–∞–º–∏.
- **–õ–µ–Ω–∏–≤—ã–π —Å—Ç–∞—Ä—Ç** ‚Äî –≤–æ—Ä–∫–µ—Ä—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ event loop (—É—Å—Ç–æ–π—á–∏–≤–æ –≤ DI/pytest).
- **–†–µ—Ç—Ä–∞–∏** ‚Äî –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ (TransientError, ConnectionError, TimeoutError, asyncio.TimeoutError) —Ä–µ—Ç—Ä–∞—è—Ç—Å—è —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º –±—ç–∫-–æ—Ñ—Ñ–æ–º.
- **DLQ** ‚Äî –ø—Ä–∏ –∏—Å—á–µ—Ä–ø–∞–Ω–∏–∏ –ø–æ–ø—ã—Ç–æ–∫ —Å–æ–±—ã—Ç–∏–µ —É—Ö–æ–¥–∏—Ç –≤ DLQ; –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ `subscribe_dlq()`.

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –∏ Health

**/metrics:**

- –ï—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω `prometheus_client` ‚Äî –æ—Ç–¥–∞—ë—Ç—Å—è Prometheus-—Ç–µ–∫—Å—Ç.
- –ò–Ω–∞—á–µ ‚Äî JSON fallback (PnL-–æ—Ç—á—ë—Ç –∏–∑ `core/analytics/metrics.py`).

**HealthChecker** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:

- –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ë–î –∏ —Ç–∞–±–ª–∏—Ü—ã –º–∏–≥—Ä–∞—Ü–∏–π,
- `fetch_ticker` –±—Ä–æ–∫–µ—Ä–∞,
- loopback-–ø—É–±–ª–∏–∫–∞—Ü–∏—é EventBus (–µ—Å–ª–∏ –µ—Å—Ç—å —à–∏–Ω–∞),
- clock drift (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –∑–∞–º–µ—Ä).

## üìö –ú–∏–≥—Ä–∞—Ü–∏–∏ (SQLite)

- –ú–∏–≥—Ä–∞—Ü–∏–∏ —á–∏—Ç–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `importlib.resources` –∏–∑ –ø–∞–∫–µ—Ç–∞ `core/storage/migrations`.
- **–í–∞–∂–Ω–æ:** `0001_init.sql` ‚Äî —á–∏—Å—Ç—ã–π SQL, –±–µ–∑ markdown-—Ñ–µ–Ω—Å–æ–≤ –∏ `#` –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `--`).
- –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ `app/compose.py` –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.

## üîí Live-—Ä–µ–∂–∏–º (ccxt)

- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `ccxt`, –∑–∞–¥–∞–π—Ç–µ `MODE=live`, `EXCHANGE`, `API_KEY`, `API_SECRET`.
- **BUY** ‚Äî —Å—É–º–º–∞ –≤ quote; **SELL** ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ base.
- –ü—Ä–æ–≤–µ—Ä—å precision/–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Å—É–º–º—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –±–∏—Ä–∂–∏.
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –±–µ–∑–æ–ø–∞—Å–Ω—ã–π dry-run –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π —Å–µ—Ç–∏ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞).

## üß∞ Makefile / CI / –õ–∏–Ω—Ç–∏–Ω–≥

–ï—Å–ª–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç:

- **Makefile** ‚Äî —Ü–µ–ª–∏ `make test`, `make run`, `make fmt`, `make lint`.
- **GitHub Actions** (`.github/workflows/ci.yml`) ‚Äî –ª–∏–Ω—Ç/—Ç–∏–ø—ã/—Ç–µ—Å—Ç—ã/coverage.
- **pyproject.toml** ‚Äî –∫–æ–Ω—Ñ–∏–≥–∏ ruff, mypy, coverage.

## üÜò Troubleshooting

- `unrecognized token: "#"` –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏—è—Ö ‚Äî –≤ `0001_init.sql` –æ—Å—Ç–∞–ª–∏—Å—å –º–∞—Ä–∫–¥–∞—É–Ω-—Ñ–µ–Ω—Å—ã. –û—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–ª—å–∫–æ —á–∏—Å—Ç—ã–π SQL –∏ `--` –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.
- `RuntimeError: no running event loop` ‚Äî –≤ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏—è—Ö —à–∏–Ω—ã –≤–æ—Ä–∫–µ—Ä—ã —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å –≤ `__init__`. –í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ EventBus ‚Äî –ª–µ–Ω–∏–≤—ã–π —Å—Ç–∞—Ä—Ç, –ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞.
- Windows –ø—É—Ç–∏ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞–≤—ã—á–∫–∏ –≤ `cd "C:\Users\..."`.
- SQLite lock ‚Äî –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Ä–µ—Å—É—Ä—Å—ã: `await bus.close()`, `broker.close()` (–µ—Å–ª–∏ async), `conn.close()`.

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–ª–æ—ë–≤

```
src/crypto_ai_bot
‚îú‚îÄ utils/                         # –≤—Ä–µ–º—è, id, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, retry, circuit breaker, –º–µ—Ç—Ä–∏–∫–∏
‚îú‚îÄ core/
‚îÇ  ‚îú‚îÄ events/                     # AsyncEventBus (per-key order, DLQ)
‚îÇ  ‚îú‚îÄ brokers/                    # –ø—Ä–æ—Ç–æ–∫–æ–ª IBroker + DTO, ccxt_exchange (live), symbols
‚îÇ  ‚îú‚îÄ storage/                    # facade + repositories (sqlite), migrations
‚îÇ  ‚îú‚îÄ risk/                       # RiskManager, ProtectiveExits
‚îÇ  ‚îú‚îÄ validators/                 # –≤–∞–ª–∏–¥–∞—Ü–∏—è DTO/–Ω–∞—Å—Ç—Ä–æ–µ–∫
‚îÇ  ‚îú‚îÄ monitoring/                 # HealthChecker
‚îÇ  ‚îú‚îÄ use_cases/                  # place_order, eval_and_execute (–±–∏–∑–Ω–µ—Å-—Ü–∏–∫–ª—ã)
‚îÇ  ‚îú‚îÄ orchestrator.py             # –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä —Ü–∏–∫–ª–æ–≤ (eval/exits/reconcile/watchdog)
‚îÇ  ‚îî‚îÄ analytics/metrics.py        # JSON-—Å–Ω–∏–º–æ–∫ –º–µ—Ç—Ä–∏–∫ (—Ñ–æ–ª–±—ç–∫)
‚îî‚îÄ app/
   ‚îú‚îÄ compose.py                  # DI-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, —Å–±–æ—Ä–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
   ‚îî‚îÄ server.py                   # FastAPI endpoints (/health, /ready, /metrics, /orchestrator)
```

**–ì—Ä–∞–Ω–∏—Ü—ã –∏–º–ø–æ—Ä—Ç–æ–≤:**  
- `app ‚Üí (core, utils)`  
- `core ‚Üí utils`  
- `utils ‚Üí ‚àÖ`  
–ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è import-linter'–æ–º.

---

## –ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è

### 1) –°–µ–º–∞–Ω—Ç–∏–∫–∞ –æ—Ä–¥–µ—Ä–æ–≤ ‚Äî –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ
- **BUY –ø–æ QUOTE:** `create_market_buy_quote("BTC/USDT", 100.0)` ‚Äî –Ω–∞ 100 USDT.  
- **SELL –ø–æ BASE:** `create_market_sell_base("BTC/USDT", 0.001)` ‚Äî 0.001 BTC.  
–≠—Ç–æ –∏—Å–∫–ª—é—á–∞–µ—Ç –¥–≤—É—Å–º—ã—Å–ª–µ–Ω–Ω–æ—Å—Ç—å `amount`.

### 2) –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ—Ä–¥–µ—Ä–æ–≤
- –ö–ª—é—á: `f"{base-quote-lower}:{side}:{bucket_ms}"`, –Ω–∞–ø—Ä., `btc-usdt:buy:1755784320000`.  
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫:  
  - `IDEMPOTENCY_BUCKET_MS` ‚Äî –æ–∫–Ω–æ –±–∞–∫–µ—Ç–∞ (ms)  
  - `IDEMPOTENCY_TTL_SEC` ‚Äî TTL –∫–ª—é—á–∞ (sec)
- –ü–æ–≤–µ–¥–µ–Ω–∏–µ: –ø–æ–≤—Ç–æ—Ä–Ω—ã–π `BUY` –≤ —Ç–æ–º –∂–µ –±–∞–∫–µ—Ç–µ ‚Üí **duplicate=true**, –æ—Ä–¥–µ—Ä –Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è.

### 3) –°–æ–±—ã—Ç–∏—è
- `AsyncEventBus`: per-key ordering, –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –Ω–∞ —Ç–æ–ø–∏–∫, DLQ, retry –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö.  
- –ú–µ—Ç—Ä–∏–∫–∏: `events_published`, `events_processed{status=ok|dlq}`.

### 4) –†–∏—Å–∫-–≥–∞—Ä–¥—Ä–µ–π–ª—ã
- –ë–∞–∑–æ–≤—ã–µ: `cooldown_sec`, `max_spread_pct`.  
- –î–æ–ø.: `daily_loss_limit_quote`, `max_position_base`, `max_orders_per_hour` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é **–≤—ã–∫–ª—é—á–µ–Ω—ã**, –Ω–µ –ª–æ–º–∞—é—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ).  
- –ú–µ—Ç—Ä–∏–∫–∞: `risk_blocked_total{reason=...}`.

### 5) –ú–µ—Ç—Ä–∏–∫–∏
- –õ—ë–≥–∫–∏–π in-memory —Ä–µ–µ—Å—Ç—Ä (`utils.metrics`) + —Ñ–æ–ª–±—ç–∫ `/metrics`:
  - –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ ‚Äî Prometheus-–ø–æ–¥–æ–±–Ω—ã–π —Ç–µ–∫—Å—Ç,
  - –∏–Ω–∞—á–µ ‚Äî JSON-—Å–Ω–∏–º–æ–∫ (`core.analytics.metrics.report_dict()`).
- –¢–∞–π–º–µ—Ä—ã: `timer("event_handle_ms", {"topic": t})` –∏ —Ç.–ø.

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (ENV)

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è                  | –¢–∏–ø     | –î–µ—Ñ–æ–ª—Ç     | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------------------------|---------|------------|----------|
| `MODE`                     | str     | `paper`    | `paper` \| `live` |
| `EXCHANGE`                 | str     | `gateio`   | –∏–º—è –±–∏—Ä–∂–∏ –≤ ccxt |
| `SYMBOL`                   | str     | `BTC/USDT` | —Ç–æ—Ä–≥—É–µ–º–∞—è –ø–∞—Ä–∞ |
| `API_KEY`, `API_SECRET`    | str     | –ø—É—Å—Ç–æ      | –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –≤ `live` |
| `FIXED_AMOUNT`             | Decimal | `10`       | —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞ **–≤ quote** –¥–ª—è buy |
| `IDEMPOTENCY_BUCKET_MS`    | int     | `60000`    | –æ–∫–Ω–æ –±–∞–∫–µ—Ç–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ |
| `IDEMPOTENCY_TTL_SEC`      | int     | `60`       | TTL –∫–ª—é—á–µ–π –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ |
| `DB_PATH`                  | str     | `:memory:` | –ø—É—Ç—å –∫ SQLite |

> –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫: `core/validators/settings.py`. `Settings.load()` ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ç–æ—á–∫–∞ —á—Ç–µ–Ω–∏—è ENV.

---

## –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä

–§–∞–π–ª: `core/orchestrator.py`.  
–¶–∏–∫–ª—ã:
- **eval_loop** ‚Äî –ø–æ—Å—Ç—Ä–æ–∏—Ç—å —Ñ–∏—á–∏ ‚Üí —Ä–µ—à–∏—Ç—å ‚Üí –∏—Å–ø–æ–ª–Ω–∏—Ç—å (use-case –≤–Ω—É—Ç—Ä–∏ –≤—ã–∑—ã–≤–∞–µ—Ç —Ä–∏—Å–∫/—ç–∫–∑–∏—Ç—ã).
- **exits_loop** ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞—â–∏—Ç–Ω—ã–µ –≤—ã—Ö–æ–¥—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–π –ø–æ–∑–∏—Ü–∏–∏.
- **reconcile_loop** ‚Äî –º—è–≥–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏/–∞—É–¥–∏—Ç–∞ (–µ—Å–ª–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –º–µ—Ç–æ–¥—ã).
- **watchdog_loop** ‚Äî heartbeat –≤ EventBus.

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ ‚Äî –ø–æ–ª—è `eval_interval_sec`, `exits_interval_sec`, `reconcile_interval_sec`, `watchdog_interval_sec`.  
–û—Ç–ª–∞–¥–∫–∞: `force_eval_action = "buy"|"sell"|"hold"|None`.

**HTTP-—Ä—É—á–∫–∏** (FastAPI):
- `POST /orchestrator/start`
- `POST /orchestrator/stop`
- `GET /orchestrator/status`

---

## API —Å–µ—Ä–≤–µ—Ä–∞

- `GET /health` ‚Äî —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (health checker).
- `GET /ready` ‚Äî –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å.
- `GET /metrics` ‚Äî Prometheus-—Ç–µ–∫—Å—Ç –∏–ª–∏ JSON-—Å–Ω–∏–º–æ–∫.
- `POST/GET /status` ‚Äî —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞/–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ).

---

## –ó–∞–ø—É—Å–∫ (–ª–æ–∫–∞–ª—å–Ω–æ)

### 1) –£—Å—Ç–∞–Ω–æ–≤–∫–∞
```bash
pip install -r requirements.txt
pip install -r requirements-dev.txt  # –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏/—Ç–µ—Å—Ç–æ–≤
```

### 2) –¢–µ—Å—Ç—ã
Windows (–Ω–∞–¥—ë–∂–Ω–µ–µ –≤—ã–∑—ã–≤–∞—Ç—å —á–µ—Ä–µ–∑ –º–æ–¥—É–ª—å):

```bat
py -m pytest -q
```

### 3) –°–µ—Ä–≤–µ—Ä
```bash
uvicorn crypto_ai_bot.app.server:app --reload
# –∏–ª–∏ python -m uvicorn crypto_ai_bot.app.server:app --reload
```

### 4) –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–ø—Ä–∏–º–µ—Ä, PowerShell)
```powershell
$env:MODE="paper"
$env:EXCHANGE="gateio"
$env:SYMBOL="BTC/USDT"
$env:FIXED_AMOUNT="10"
$env:IDEMPOTENCY_BUCKET_MS="60000"
$env:IDEMPOTENCY_TTL_SEC="60"
```

## –ö–∞—á–µ—Å—Ç–≤–æ –∏ –≥–∞—Ä–∞–Ω—Ç–∏–∏

- –¢–∏–ø—ã/DTO –∂—ë—Å—Ç–∫–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã (`brokers/base.py`).
- –°–µ–º–∞–Ω—Ç–∏–∫–∞ –æ—Ä–¥–µ—Ä–æ–≤ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–∞.
- –°–æ–±—ã—Ç–∏—è —Å –≥–∞—Ä–∞–Ω—Ç–∏–µ–π –ø–æ—Ä—è–¥–∫–∞ per-key + DLQ.
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ—Ä–¥–µ—Ä–æ–≤ –∏ –∫–ª—é—á–µ–π.
- –ú–µ—Ç—Ä–∏–∫–∏ –≤–µ–∑–¥–µ, JSON-—Ñ–æ–ª–±—ç–∫ –¥–ª—è `/metrics`.
- –ò–º–ø–æ—Ä—Ç-–≥—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è (import-linter).
- –Æ–Ω–∏—Ç/–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã ‚Äî –∑–µ–ª—ë–Ω—ã–µ –Ω–∞ Python 3.13/Windows.

## –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ / —á–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è

- `utils/` ‚Äî –≥–æ—Ç–æ–≤—ã–µ: time, ids, logging, metrics, retry, circuit_breaker, exceptions.
- `core/events` ‚Äî –≥–æ—Ç–æ–≤–æ: —à–∏–Ω–∞ —Å–æ–±—ã—Ç–∏–π, —Ç–µ–º—ã.
- `core/brokers` ‚Äî –ø—Ä–æ—Ç–æ–∫–æ–ª + ccxt-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (live), –ø–∞—Ä—Å–µ—Ä —Å–∏–º–≤–æ–ª–æ–≤.
- `core/storage` ‚Äî —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, facade, –º–∏–≥—Ä–∞—Ü–∏–∏.
- `core/risk` ‚Äî RiskManager + ProtectiveExits; –≥–∞—Ä–¥—Ä–µ–π–ª—ã; –º–µ—Ç—Ä–∏–∫–∞ risk_blocked_total.
- `core/use_cases` ‚Äî place_order / eval_and_execute.
- `core/orchestrator.py` ‚Äî –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä; server-—Ä—É—á–∫–∏ –¥–ª—è start/stop/status.
- `app/compose.py` ‚Äî —Å–±–æ—Ä–∫–∞ DI-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (—Ä–µ–∂–∏–º—ã paper/live).
- `app/server.py` ‚Äî endpoints: /health, /ready, /metrics, /orchestrator/*.

---

## üìú –õ–∏—Ü–µ–Ω–∑–∏—è
¬© –í—ã–±–æ—Ä –ª–∏—Ü–µ–Ω–∑–∏–∏ –∑–∞ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.