[importlinter]
root_package = crypto_ai_bot
include_external_packages = False
# кеш, чтобы ускорить
cache_dir = .import_linter_cache

[settings]
# Глобальные исключения из графа импортов (чтобы не влияли на контракты)
# Ничего не исключаем — всё регулируем контрактами ниже.

# ───────────────────────────────────────────────────────────────────────────────
# LAYERS: Чистая архитектура (наружу → внутрь)
# app (входная точка, API/бот/композиция)
# core.infrastructure (адаптеры: брокер, БД, HTTP и т.д.)
# core.application (use cases, orchestrator, risk)
# core.domain (модели, стратегии, сигналы, инварианты)
# ───────────────────────────────────────────────────────────────────────────────
[contract:layers_clean_arch]
name = Clean architecture layers
type = layers
layers =
    crypto_ai_bot.app
    crypto_ai_bot.core.infrastructure
    crypto_ai_bot.core.application
    crypto_ai_bot.core.domain
ignore_imports =
    # Разрешаем тестам и скриптам «видеть» всё:
    tests -> *
    scripts -> *
    # Миграции тоже не проверяем: там raw-SQL и служебные импорты:
    crypto_ai_bot.core.infrastructure.storage.migrations -> *

# ───────────────────────────────────────────────────────────────────────────────
# FORBIDDEN: Домейн не импортирует ничего внешнего
# (дублирует смысл layers, но даёт более явные отчёты)
# ───────────────────────────────────────────────────────────────────────────────
[contract:domain_must_be_pure]
name = Domain must not depend on outer layers
type = forbidden
source_modules =
    crypto_ai_bot.core.domain
forbidden_modules =
    crypto_ai_bot.core.application
    crypto_ai_bot.core.infrastructure
    crypto_ai_bot.app

# ───────────────────────────────────────────────────────────────────────────────
# FORBIDDEN: Application не импортирует infrastructure и app
# (использует ПОРТЫ из core.application.ports / core.domain.*.ports)
# ───────────────────────────────────────────────────────────────────────────────
[contract:application_cannot_depend_on_infra]
name = Application must not depend on infrastructure or app
type = forbidden
source_modules =
    crypto_ai_bot.core.application
forbidden_modules =
    crypto_ai_bot.core.infrastructure
    crypto_ai_bot.app

# ───────────────────────────────────────────────────────────────────────────────
# FORBIDDEN: Infrastructure не импортирует app (композиция только в app)
# ───────────────────────────────────────────────────────────────────────────────
[contract:infra_cannot_depend_on_app]
name = Infrastructure must not depend on app
type = forbidden
source_modules =
    crypto_ai_bot.core.infrastructure
forbidden_modules =
    crypto_ai_bot.app

# ───────────────────────────────────────────────────────────────────────────────
# INDEPENDENCE: Поддомены домейна не тянут инфраструктуру
# (особенно macro/strategies/signals)
# ───────────────────────────────────────────────────────────────────────────────
[contract:domain_subpackages_are_pure]
name = Domain subpackages must be pure
type = forbidden
source_modules =
    crypto_ai_bot.core.domain.macro
    crypto_ai_bot.core.domain.strategies
    crypto_ai_bot.core.domain.signals
forbidden_modules =
    crypto_ai_bot.core.infrastructure
    crypto_ai_bot.app
    crypto_ai_bot.core.application

# ───────────────────────────────────────────────────────────────────────────────
# INDEPENDENCE: Инфраструктурные подсекции не зависят друг от друга напрямую
# (например, brokers не импортирует storage.* и наоборот — через application ports)
# Если где-то нужна связь — через порты в application.
# ───────────────────────────────────────────────────────────────────────────────
[contract:infra_sections_independent]
name = Infrastructure sections are independent
type = independence
modules =
    crypto_ai_bot.core.infrastructure.brokers
    crypto_ai_bot.core.infrastructure.storage
    crypto_ai_bot.core.infrastructure.events
    crypto_ai_bot.core.infrastructure.macro

# ───────────────────────────────────────────────────────────────────────────────
# ИСКЛЮЧЕНИЯ ПО ПУТЯМ (модули, которые import-linter вообще не анализирует):
# ───────────────────────────────────────────────────────────────────────────────
[whitelist]
modules =
    tests
    scripts
    crypto_ai_bot.core.infrastructure.storage.migrations
