name: ci

on:
  push:
  pull_request:

jobs:
  lint-test-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install ruff isort mypy pytest

      - name: Ruff (lint)
        run: ruff check .

      - name: isort (imports)
        run: isort --check-only .

      - name: mypy (types; узкий слой)
        run: |
          mypy --config-file mypy.ini

      - name: Smoke run (paper mode, no network)
        env:
          MODE: paper
          EXCHANGE: gateio
          SYMBOL: BTC/USDT
          FIXED_AMOUNT: "50"
          DATA_DIR: ./data
          IDEMPOTENCY_BUCKET_MS: "60000"
          IDEMPOTENCY_TTL_SEC: "600"
        run: |
          python - <<'PY'
          import os, asyncio
          os.environ.setdefault("MODE","paper")
          from crypto_ai_bot.app.compose import build_container
          from crypto_ai_bot.core.application.use_cases.eval_and_execute import eval_and_execute
          from crypto_ai_bot.utils.decimal import dec
          async def main():
              c = build_container()
              order = await eval_and_execute(
                  symbol=os.getenv("SYMBOL","BTC/USDT"),
                  storage=c.storage, broker=c.broker, bus=c.bus, exchange=c.settings.EXCHANGE,
                  fixed_quote_amount=dec("25"),
                  idempotency_bucket_ms=c.settings.IDEMPOTENCY_BUCKET_MS,
                  idempotency_ttl_sec=c.settings.IDEMPOTENCY_TTL_SEC,
                  force_action="buy",
                  risk_manager=c.risk, protective_exits=c.exits, settings=c.settings,
                  fee_estimate_pct=c.settings.FEE_PCT_ESTIMATE,
              )
              assert order is not None
              print("smoke_ok", order.client_order_id)
          asyncio.run(main())
          PY

      - name: Pytest (unit only)
        env:
          MODE: paper
          EXCHANGE: gateio
          SYMBOL: BTC/USDT
        run: |
          pytest -q -m "not live" || pytest -q
